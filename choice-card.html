<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="choice-form.html">
<!--
This component is a form that fires an event with request object on click of dropdown option 'need more rooms or have children'.

This component use the component 'choice form'  containing values of all input fields of drop down for adult children and child age .

Example:

    <choice-card>
    </choice-card>

Note:
The form handles below mentioned scenarios on its own.

1. A minimum of 1 adult is required to book a hotel.
2. Children are considered below 12yrs old.
3. Child age is mandatory.

-->
<dom-module id="choice-card">
    <template>
        <style>
             :host {
                display: block;
            }

            .hidden {
                display: none;
            }

            .unhidden {
                display: block;
            }

            #errfn {
                color: red;
                position: absolute;
                width: 100%;
                margin-top: -17px;
            }

            #countError {
                width: 100%;
                height: 12px;
                float: left;
                display: none;
            }

            #linePaper {
                width: 92%;
                float: left;
            }

            #paperMaterial {
                background-color: whitesmoke;
                width: 500px;
            }

            #formDiv {
                float: left;
                width: 100%;
            }

            #delButton {
                height: 35px;
                width: 35px;
            }

            #btnAddRoom {
                position: relative;
            }

            @media (min-width: 768px) and (max-width: 1024px) {
                .head {
                    float: left;
                    width: 100%;
                    margin-top: 20px;
                    margin-left: 2%;
                    height: 40px;
                }
                .button {
                    padding: 0px 0px;
                }
                .buttons {
                    color: var(--color-for-button);
                    float: right;
                    margin-right: 10px;
                    margin-top: 5px;
                }
                #btnAddRoom {
                    color: var(--color-for-button);
                    float: left;
                    margin-right: 10px;
                    margin-top: 20px;
                    float: clear;
                }
                #btnDone {
                    float: left;
                    display: block;
                    margin-right: 10px;
                    margin-top: 20px;
                }
                #line {
                    width: 100%;
                    border-bottom: 1px solid silver;
                    height: 12px;
                    margin: -20px 0 10px 20px;
                }
                #line span {
                     background-color: var(--color-for-room, white);
                    padding: 10px;
                    font-size: 16px;
                    margin-left: -40px;
                    color: silver;
                }
                #deleteButton {
                    float: right;
                    margin-right: -15px;
                    margin-top: -60px;
                }
                #linePaper {
                    width: 85%;
                    float: left;
                }
            }

            @media (max-width: 767px) {
                .head {
                    float: left;
                    width: 100%;
                    margin-top: 20px;
                }
                .button {
                    margin-top: -20px;
                    padding: 0px 0px;
                }
                #btnAddRoom {
                    color: var(--color-for-button);
                    position: initial;
                    margin-right: 10px;
                    margin-top: 20px;
                }
                #btnDone {
                    display: none;
                }
                #deleteButton {
                    float: right;
                    margin-top: -50px;
                    margin-right: -35px;
                }
                #line {
                    width: 100%;
                    border-bottom: 1px solid silver;
                    height: 12px;
                    margin: -20px 0 10px -13px;
                }
                #line span {
                     background-color: var(--color-for-room, white);
                    padding: 10px;
                    font-size: 16px;
                    margin-left: -10px;
                    color: silver;
                }
            }

            @media (min-width: 1024px) and (max-width:2200px) {
                .head {
                    float: left;
                    width: 100%;
                    margin-top: 20px;
                    margin-left: 2%;
                }
                .button {
                    margin-top: -20px;
                    margin-right: -20px;
                    padding: 0px 0px;
                }
                .buttons {
                    color: var(--color-for-button);
                    float: right;
                    margin-right: 10px;
                    margin-top: 5px;
                }
                #btnAddRoom {
                    color: var(--color-for-button);
                    float: left;
                    margin-right: 10px;
                    margin-top: 20px;
                    float: clear;
                }
                #btnDone {
                    float: left;
                    display: block;
                    margin-right: 10px;
                    margin-top: 20px;
                }
                #deleteButton {
                    float: right;
                    margin-top: -50px;
                }
                #line {
                    width: 100%;
                    border-bottom: 1px solid silver;
                    height: 12px;
                    margin: -20px 0 10px -13px;
                }
                #line span {
                     background-color: var(--color-for-room, white);
                    padding: 10px;
                    font-size: 16px;
                    margin-left: -10px;
                    color: silver;
                }
            }

            @media all and (-ms-high-contrast:none) {
                .head {
                    float: left;
                    width: 100%;
                    margin-top: 20px;
                }
                #deleteButton {
                    float: right;
                    margin-top: -34px;
                }
                .button {
                    margin-top: 4px;
                    padding: 0px 0px;
                }
                #line {
                    width: 100%;
                    border-bottom: 1px solid silver;
                    height: 12px;
                    margin: 15px 0 10px -13px;
                }
                #line span {
                    background-color: var(--color-for-room, white);
                    padding: 10px;
                    font-size: 16px;
                    margin-left: -10px;
                    color: silver;
                }
                #formDiv {
                    margin-top: -15px;
                }
            }
        </style>

        <paper-material id="paperMaterial">
            <div id="formDiv">
                <form is="iron-form" id="form" method="post" action="/form/handler">

                    <template is='dom-repeat' items={{rooms}} id="choiceForms">

                        <div class="head">
                            <paper-item id="linePaper" disabled>
                                <div id="line"><span>{{resources.room}}# {{_displayIndex(index)}}</span></div>
                            </paper-item>

                            <paper-item id="deleteButton" on-keydown="_onkeyPress">
                                <paper-button toggles hidden="[[_isDeleteHidden]]" class=button on-click="_deleteRoom" id="delButton">
                                    <img src="[[importPath]]trash.svg" height="15px" width="15px">
                                    <iron-icon id="clearButton" icon="icons:delete"></iron-icon>
                                </paper-button>
                            </paper-item>

                            <div id="countError"><span id="errfn"></span></div>
                        </div>
                      
                        <choice-form index="{{_displayIndex(index)}}"
                                resources=[[resources]]
                                is-mobile="[[isMobile]]"
                                room ="{{item}}"
                                search-option=[[searchOption]] id="choiceRoom"></choice-form>

                    </template>

                </form>
            </div>
            <div class="buttons">
                <paper-button id="btnAddRoom" toggles on-tap='_addRoom' style="position: relative">Add Room</paper-button>
                <paper-button id="btnDone" toggles on-click='_doneRoom' hidden$="{{showButton}}">Done</paper-button>
            </div>
        </paper-material>

    </template>
    <script>

        Polymer({
            is: 'choice-card',
            properties: {

                /**
                * This is an array of rooms.
                * Rooms can be added by clicking on add room button and can be deleted by clicking on trash icon.
                *@private
                **/
                rooms: {
                    type: Array,
                    notify: true,
                    value: function(){
                        return [{  adult : 1, child : 0, childAge:[] }]
                    }
                },

                isMobile:Boolean,
                /**
                 * This property is set to hidden attribute of delete button.
                 * when room count is 1 then delete button should be hidden.
                *@private
                 **/

                _isDeleteHidden: {
                    type: Boolean,
                    computed: '_lte(rooms.length , 1)'
                },
                /**
                 * Property to hide done button when screen is below 767px i.e in mobile view.
                *@private
                 **/

                showButton: {
                    type: Boolean,
                    value: function () {
                        if (this.isMobile) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                },

                roomCount: {
                    type: Number,
                    value: 0
                },


                resources :{
                    type:Object
                },

                searchOption : {
                    type:Object,
                    value:{}
                }
            },

            /**
             * This is function for computed value of _isDeleteHidden property.
             * This function is used for hide delete button when room count is 1.
             **/

            _lte: function (roomLength, hiddenButtonRoomNumber) {
                return roomLength <= hiddenButtonRoomNumber;
            },
           
            /**
             * To delete rooms on enter key press.
             * */
            _onkeyPress: function (e) {
                var key = e.key;
                if (this.rooms.length > 1 && key === "Enter") {
                    this._deleteRoom(e);
                }
            },

            /**
            *This function is used when Add Room button is clicked,
            *on click this function adds the room into travellers form.
            **/
            _addRoom: function () {
                if (this.rooms.length < this.searchOption.maxRoomCount) {
                    this.push('rooms', { adult: 1, child : 0, childAge:[] });
                    // this.push('totalData', { total: "" });
                    // this.roomCount = this.roomCount + 1;
                    Polymer.RenderStatus.afterNextRender(this, function () {
                        this.domHost.$.paperCard.scrollTop = this.domHost.$.paperCard.scrollHeight;
                    });
                }
                if (this.rooms.length == this.searchOption.maxRoomCount) {
                    this.$.btnAddRoom.style.visibility = "hidden";
                }
            },

            /**
            *Function to display index for rooms according to add and delete function.
            **/

            _displayIndex: function (index) {
                index = index + 1;
                return index;
            },

            /**
            *This function is used for delete Room button (trash icon),
            *on click this function delete the room from form.
            **/

            _deleteRoom: function (e) {
                this.splice('rooms', e.model.index, 1);              
                this.$.btnAddRoom.style.visibility = "visible";
            },

            /**
            *Function works for done button .
            *On click it count total adults, children nad rooms from the form.
            *Output gives to the dropdown to show it's content instead of 'need rooms or have children'.
            *It also provides the array containing adultCount, childCount and array for children ages for each room.
            **/

            _doneRoom: function (event) {
            
                var isValid = true;
                for(var i=0; i< this.rooms.length; i++){
                    var room = this.rooms[i];

                    var childCnt = parseInt(room.child);
                    if(childCnt>0){
                        for(var cntChild=0; cntChild<childCnt; cntChild++){
                            var flag = false;
                            if(parseInt(room.childAge[cntChild].age)==0){
                                flag = true;
                                isValid =false
                            }
                            this.set(`rooms.${i}.childAge.${cntChild}.invalid`, flag);
                        }
                    }
                }

                if(isValid){
                    this.dispatchEvent(new CustomEvent("traveler-selected", {
                        detail : this.rooms
                    }));
                }
                
                return isValid;
            },

            /**
            *
            **/
            triggerDone: function(){
                this._doneRoom();
            }
        })
    </script>
</dom-module>