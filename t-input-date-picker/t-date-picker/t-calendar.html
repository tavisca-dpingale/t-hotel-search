<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-styles/default-theme.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/moment-element/moment-import.html">
<link rel="import" href="t-date-picker-icons.html">

<dom-module id="t-calendar">
  <template>
    <style>
      .selectedRange {
        border-top: 1px solid var(--color-for-calendar-selected-range);
        border-bottom: 1px solid var(--color-for-calendar-selected-range);
      }
      
      .selectEndBorder .borderDiv {
        border-top: 1px solid var(--color-for-calendar-selected-range);
        border-bottom: 1px solid var(--color-for-calendar-selected-range);
      }
      
      .selectStartBorder .borderDiv {
        margin-left: 51%;
        border-top: 1px solid var(--color-for-calendar-selected-range);
        border-bottom: 1px solid var(--color-for-calendar-selected-range);
      }
      
      .selectedRangeSun {
        border-left: 1px solid var(--color-for-calendar-selected-range);
        border-top-left-radius: 100%;
        border-bottom-left-radius: 100%;
        border-top: 1px solid var(--color-for-calendar-selected-range);
        border-bottom: 1px solid var(--color-for-calendar-selected-range);
      }
      
      .selectedRangeSat {
        border-right: 1px solid var(--color-for-calendar-selected-range);
        border-top-right-radius: 100%;
        border-bottom-right-radius: 100%;
        border-top: 1px solid var(--color-for-calendar-selected-range);
        border-bottom: 1px solid var(--color-for-calendar-selected-range);
      }
      
      .selectfirst {
        background-image: var(--background-img-for-selected-date);
        background-repeat: no-repeat;
        color: white;
      }
      
      .selectlast {
        background-image: var(--background-img-for-selected-date);
        background-repeat: no-repeat;
        -webkit-text-fill-color: white;
        color: white;
      }
      
      .selectToday {
        background-image: var(--background-img-for-today-date);
        background-repeat: no-repeat;
        color: var(--color-for-calendar-selected-range);
        background-position: 50%;
        border-radius: 100%;
      }
      
       :host {
        display: inline;
        box-sizing: border-box;
        padding: 12px 0;
        position: relative;
        width: 100%;
        height: 100%;
        min-width: 360px;
        min-height: 160px;
        color: var(--primary-text-color);
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        --ease-in-sine: cubic-bezier(0.47, 0, 0.745, 0.715);
        --ease-out-sine: cubic-bezier(0.39, 0.575, 0.565, 1);
        @apply(--paper-font-body1);
        @apply(--paper-calendar);
        overflow: hidden;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        @apply(--paper-calendar);
      }
      
      #calendar {
        position: relative;
        width: 100%;
        height: 100%;
        @apply(--layout-horizontal);
      }
      
      #months {
        width: 100%;
        height: 100%;
        @apply(--layout-horizontal);
      }
      
      #months.animating .month-nav {
        opacity: 1;
      }
      
      #months.animating {
        transition-property: transform, opacity;
        transition-duration: 0.00000000000001s;
        -moz-transition-property: transform, none;
        -moz-transition-duration: 0.0000000001s;
      }
      
      #months.animating.swipe {
        transition-timing-function: var(--ease-in-sine);
        --webkit-transition-timing-function: var(--ease-in-sine);
      }
      
      #months.animating.reset {
        transition-timing-function: var(--ease-out-sine);
        --webkit-transition-timing-function: var(--ease-out-sine);
      }
      
      .month {
        height: 100%;
        @apply(--layout-vertical);
        @apply(--layout-justified);
        @apply(--layout-flex);
        border-left: 1px solid lightgray;
      }
      
      .month-row,
      .month-nav {
        width: 250px;
        height: calc(100%/8);
        box-sizing: border-box;
        padding: 0 calc(100%/36);
      }
      
      .month-col {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      
      .month-nav {
        position: absolute;
        top: 0;
        left: 0;
        width: 40px;
        opacity: 1;
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      
      .month-nav .col {
        position: relative;
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }
      
      .month-nav .btn .icon {
        cursor: pointer;
        color: gray;
      }
      
      .month-nav .btn .ripple {
        position: absolute;
        width: 48px;
        height: 48px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      
      .month-nav .btn.right {
        text-align: right;
      }
      
      .month-name {
        line-height: 24px;
        vertical-align: middle;
        text-align: center;
        font-weight: bold;
        color: black;
        @apply(--paper-font-body2);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        @apply(--layout-flex);
      }
      
      .month-weekdays {
        color: gray;
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-flex);
      }
      
      .month-days {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-flex);
      }
      
      .month-col .day {
        cursor: default;
        pointer-events: none;
        @apply(--layout-fit);
        @apply(--layout-vertical);
        @apply(--layout-center-center);
      }
      
      .month-col {
        position: relative;
        width: 100%;
        height: 100%;
        @apply(--layout-center-center);
      }
      
      .day-item {
        width: 100%;
        height: 100%;
      }
      
      .day-item::selection {
        background: none;
      }
      
      .day-item.selected .day {
        color: var(--text-primary-color);
      }
      
      .day-item:not([disabled]) {
        cursor: pointer;
      }
      
      .day-item[disabled] .day {
        color: var(--text-disabled-color, lightgray);
      }
      
      .day-item.selected.today .day {
        color: var(--text-primary-color);
        background-color: white;
        border: gray solid 1px;
        border-radius: 100%;
      }
      
      .flex {
        @apply(--layout-flex);
      }
      
      .flex-5 {
        @apply(--layout-flex-5);
      }
      
      @media (min-width: 300px) {
         :host {
          display: block;
          box-sizing: border-box;
          padding: 12px 0;
          position: relative;
          width: 100%;
          height: 100%;
          min-width: 100%;
          min-height: 380px;
          color: var(--primary-text-color);
          -webkit-font-smoothing: antialiased;
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
          --ease-in-sine: cubic-bezier(0.47, 0, 0.745, 0.715);
          --ease-out-sine: cubic-bezier(0.39, 0.575, 0.565, 1);
          @apply(--paper-font-body1);
          @apply(--paper-calendar);
          overflow: hidden;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          @apply(--paper-calendar);
        }
        .month-nav {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          min-width: 100%;
          opacity: 1;
          @apply(--layout-horizontal);
          @apply(--layout-center);
        }
        .month-row,
        .month-nav {
          width: 100%;
          min-width: 100%;
          height: calc(100%/8);
          box-sizing: border-box;
          padding: 0 calc(100%/36);
        }
        .month-col {
          position: relative;
          @apply(--layout-vertical);
          @apply(--layout-flex);
        }
      }
      
      @media (max-width: 767px) {
        .month {
          min-width: 100%;
          height: 100%;
          overflow: auto;
          @apply(--layout-vertical);
          @apply(--layout-justified);
          @apply(--layout-flex);
          border-left: 1px solid lightgray;
        }
        .month-nav {
          display: none;
        }
        .selectfirst {
          background-position: 50%;
        }
        .selectlast {
          background-position: 50%;
        }
        .month-row,
        .month-nav {
          height: calc(100%/9);
        }
        #calendar {
          overflow: auto;
        }
        #months {
          display: block;
          height: 86%;
        }
      }
      
      @media (min-width: 768px) and (max-width: 1023px) {
         :host {
          display: inline;
          box-sizing: border-box;
          padding: 12px 0;
          position: relative;
          width: 100%;
          height: 100%;
          min-width: 300px;
          min-height: 160px;
          color: var(--primary-text-color);
          -webkit-font-smoothing: antialiased;
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
          --ease-in-sine: cubic-bezier(0.47, 0, 0.745, 0.715);
          --ease-out-sine: cubic-bezier(0.39, 0.575, 0.565, 1);
          @apply(--paper-font-body1);
          @apply(--paper-calendar);
          overflow: hidden;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          @apply(--paper-calendar);
        }
        .month-nav {
          position: absolute;
          top: 0;
          left: 0;
          width: 350px;
          opacity: 1;
          @apply(--layout-horizontal);
          @apply(--layout-center);
        }
        .month-row,
        .month-nav {
          width: 250px;
          height: calc(100%/8);
          box-sizing: border-box;
          padding: 0 calc(100%/36);
        }
        .month-col {
          position: relative;
          @apply(--layout-vertical);
          @apply(--layout-flex);
        }
        #monthNav {
          width: 114%;
          margin-left: -46px;
        }
        .selectfirst {
          background-position: 50%;
        }
        .selectlast {
          background-position: 50%;
        }
      }
      
      @media (min-width: 1024px) and (max-width: 1200px) {
         :host {
          display: inline;
          box-sizing: border-box;
          padding: 12px 0;
          position: relative;
          width: 100%;
          height: 100%;
          min-width: 300px;
          min-height: 160px;
          color: var(--primary-text-color);
          -webkit-font-smoothing: antialiased;
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
          --ease-in-sine: cubic-bezier(0.47, 0, 0.745, 0.715);
          --ease-out-sine: cubic-bezier(0.39, 0.575, 0.565, 1);
          @apply(--paper-font-body1);
          @apply(--paper-calendar);
          overflow: hidden;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          @apply(--paper-calendar);
        }
        .month-nav {
          position: absolute;
          top: 0;
          left: 0;
          width: 350px;
          opacity: 1;
          @apply(--layout-horizontal);
          @apply(--layout-center);
        }
        .month-row,
        .month-nav {
          width: 250px;
          height: calc(100%/8);
          box-sizing: border-box;
          padding: 0 calc(100%/36);
        }
        .month-col {
          position: relative;
          @apply(--layout-vertical);
          @apply(--layout-flex);
        }
        #monthNav {
          width: 112%;
          margin-left: -37px;
        }
        .selectfirst {
          background-position: 50%;
        }
        .selectlast {
          background-position: 50%;
        }
      }
      
      @media (min-width: 1200px) {
         :host {
          display: inline;
          box-sizing: border-box;
          padding: 12px 0;
          position: relative;
          width: 100%;
          height: 100%;
          min-width: 300px;
          min-height: 160px;
          color: var(--primary-text-color);
          -webkit-font-smoothing: antialiased;
          -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
          --ease-in-sine: cubic-bezier(0.47, 0, 0.745, 0.715);
          --ease-out-sine: cubic-bezier(0.39, 0.575, 0.565, 1);
          @apply(--paper-font-body1);
          @apply(--paper-calendar);
          overflow: hidden;
          -webkit-touch-callout: none;
          -webkit-user-select: none;
          -khtml-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          @apply(--paper-calendar);
        }
        .month-nav {
          position: absolute;
          top: 0;
          left: 0;
          width: 350px;
          opacity: 1;
          @apply(--layout-horizontal);
          @apply(--layout-center);
        }
        .month-row,
        .month-nav {
          width: 250px;
          height: calc(100%/8);
          box-sizing: border-box;
          padding: 0 calc(100%/36);
        }
        .month-col {
          position: relative;
          @apply(--layout-vertical);
          @apply(--layout-flex);
        }
        #monthNav {
          width: 112%;
          margin-left: -37px;
        }
        .selectfirst {
          background-position: 50%;
        }
        .selectlast {
          background-position: 50%;
        }
      }
    </style>
    <div id="calendar">
      <div id="months" on-track="_onTrack" class$="{{_contentClass}}" style="width:100%">
        <template is="dom-repeat" items="{{_months}}" as="month">
          <div class$="{{_getMonthClass('month', month)}}">
            <div class="month-row month-name">
              <span>{{dateFormat(month.date, 'MMMM YYYY', locale)}}</span>
            </div>
            <div class="month-row month-weekdays week">
              <template is="dom-repeat" items="{{_weekdays}}">
                <div class="month-col layout vertical flex">
                  <div class="day" id="weekday">{{item.0}}</div>
                </div>
              </template>
            </div>
            <template is="dom-repeat" items="{{month.weeks}}" as="row">
              <div class="month-row month-days">
                <template is="dom-repeat" items="{{row}}">
                  <div dialog-confirm class="month-col">
                    <div class$="{{_getDayClass('day-item selection', item.date, today, date)}}" disabled$="{{_isDisabled(item.day, item.date, minDate, maxDate)}}"
                      on-tap="_tapDay" date$="{{item.name}}">
                      <div class="borderDiv" style="width:50%;height:100%;"></div>
                      <div style="width:50%; margin-left:22%;" class="day">{{item.day}}</div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>
      <div id="monthNav" class="month-nav">
        <div class="flex col self-stretch">
          <div class="btn" on-tap="_swipePrevMonth">
            <paper-ripple center class="ripple circle"></paper-ripple>
            <iron-icon class="icon flex" icon="date-picker:chevron-left"></iron-icon>
          </div>
        </div>
        <div class="flex-5"></div>
        <div class="flex col self-stretch">
          <div class="btn" on-tap="_swipeNextMonth">
            <paper-ripple center class="ripple circle"></paper-ripple>
            <iron-icon class="icon flex" icon="date-picker:chevron-right"></iron-icon>
          </div>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function () {

      // Ignore movement within this distance (px)
      var WIGGLE_THRESHOLD = 4;
      var WIGGLE_THRESHOLD_SQUARE = WIGGLE_THRESHOLD * WIGGLE_THRESHOLD;

      // what constitues a flick (px/ms)
      var FLICK_SPEED = 0.5;

      // Factor for "springy" resistence effect when swiping too far.
      var RESIST_LENGTH = 40;
      var RESIST_FACTOR = 2;

      // Number of months to preload on both sides of the current month
      var PRELOAD_MONTHS = 1;

      function dateDiff(a, b) {
        a = new Date(a.getTime());
        b = new Date(b.getTime());
        a.setHours(0, 0, 0, 0);
        b.setHours(0, 0, 0, 0);
        return (a.getTime() - b.getTime()) / 86400000;
      }

      Polymer({
        is: 't-calendar',
        properties: {
          /*
           * The selected date
           */
          date: {
            type: Date,
            notify: true,
            value: function () {
              return new Date();
            },
            // observer: '_dateChanged'
          },
          showMonthName: {
            type: Boolean,
            value: true
          },

          scrollToMonth: {
            type: Number,
            value: 0
          },
          /**
           *This property set to checkout date after 6 days. 
           */
          setCheckOut: {
            type: Number,
            value: 6
          },
          /**
           * The current locale
           */
          locale: {
            type: String,
            value: 'en',
            notify: true,
            observer: '_localeChanged'
          },
          /**
           * The minimum allowed date
           */
          minDate: {
            type: Date,
            value: null
          },
          /**
           * The maximum allowed date
           */
          maxDate: {
            type: Date,
            value: null
          },
          /**
           * The currently selected month (1-12)
           */
          currentMonth: {
            type: Number
          },
          /**
           * The currently selected year
           */
          currentYear: {
            type: Number
          },
          _contentClass: String,
          _months: Array,
          _firstDayOfWeek: Number,
          /**
           * This property is check to first day of week.
          */
          checkFirstDayofWeek: String,
        },
        behaviors: [
          Polymer.IronResizableBehavior
        ],
        observers: [
          '_populate(currentYear, currentMonth, locale)',
        ],
        listeners: {
          'iron-resize': '_resizeHandler',
          'swiped': '_onSwipe'
        },
        ready: function () {
          this._updateToday();
          this.currentMonth = this.date.getMonth() + 1;
          this.currentYear = this.date.getFullYear();
          this._transitionEvent = this._whichTransitionEnd();
        },
        dateFormat: function (date, format, locale) {
          if (!date) {
            return '';
          }
          var value = moment(date);
          value.locale(locale || this.locale);
          return value.format(format);
        },
        dateFormatMonthName: function (date, format, locale) {
          if (!date) {
            return '';
          }
          var date = date;
          date.setDate(date.getDate() + 31);
          var value = moment(date);
          value.locale(locale || this.locale);
          return value.format(format);
        },
        _localeChanged: function (locale) {
          var localeMoment = moment();
          localeMoment.locale(locale);
          var weekdays = [];
          for (var i = 0; i < 7; i++) {
            weekdays.push(localeMoment.weekday(i).format('dd'));
            if (i === 0) {
              this.checkFirstDayOfWeek = localeMoment.weekday(i).format('dddd');
            }
          }
          this._weekdays = weekdays;
          this._firstDayOfWeek = localeMoment.weekday(0).format('d');
          // this.checkFirstDayOfWeek = localeMoment.weekday(0).format('dddd');
        },
        _changeMinDate: function () {
          if (this.minDate === null) {
            this.minDate = new Date();
          }
          if (this.maxDate === null) {
            this.maxDate = new Date(new Date().setFullYear(new Date().getFullYear() + 1));
          }
          if(this.minDate.getFullYear() === this.maxDate.getFullYear()){
             var setMinDate = this.maxDate.getMonth() -  this.minDate.getMonth();
          }else{
          var setMinDate = (12 - this.minDate.getMonth()) + this.maxDate.getMonth();
          }
          return setMinDate;
        },

        _populate: function (currentYear, currentMonth) {

          var date, month, weeks, day, d, dayInfo, monthData, months = [];
          var screen = window.matchMedia("(max-width:767px)");
          if (screen.matches) {
            PRELOAD_MONTHS = this._changeMinDate();
          }
          // Make sure currentYear/currentMonth are in min/max range
          if (this.minDate && new Date(currentYear, currentMonth, 0) < this.minDate) {

            this.currentYear = this.minDate.getFullYear();
            this.currentMonth = this.minDate.getMonth() + 1;
            return;
          } else if (this.maxDate && new Date(currentYear, currentMonth - 1, 1) > this.maxDate) {
            this.currentYear = this.maxDate.getFullYear();
            this.currentMonth = this.maxDate.getMonth() + 1;
            return;
          }
        
          for (var i = 0; i <= PRELOAD_MONTHS; i++) {
            weeks = [[]];
            day = 1;
            date = new Date(currentYear, currentMonth - 1 + i, 1);
            month = date.getMonth();
            monthData = {
              year: date.getFullYear(),
              month: date.getMonth() + 1,
              date: new Date(date)
            };
            var firstDay = date.getDay() - this._firstDayOfWeek;
            if (firstDay < 0) {
              firstDay = 7 + firstDay;
            }
            for (d = 0; d < firstDay; d++) {
              weeks[0].push({ day: null, date: null });
            }

            // add actual days
            while (date.getMonth() === month) {
              if (weeks[0].length && d % 7 === 0) {
                // start new week
                weeks.push([]);
              }
              dayInfo = {
                date: new Date(date.getFullYear(), month, day),
                name: this.dateFormat(date, 'YYYY-MM-DD'),
                year: currentYear,
                month: month,
                day: day,
              };
              weeks[weeks.length - 1].push(dayInfo);
              date.setDate(++day);
              d++;
            }

            // add remaining "padding" days
            while (d < 42) {
              if (d % 7 === 0) {
                weeks.push([]);
              }
              weeks[weeks.length - 1].push({ day: null, date: null });
              d += 1;
            }

            monthData.weeks = weeks;
            months.push(monthData);

          }
          if (!months.length) {
            return;
          }
          this.set('_months', months);
          this.async(function () {
            this._updateSelection();
            this._positionSlider();
          });
        },
      

        _getDayClass: function (cssClass, date) {
          var startDateDefined = true;
          if (date) {
            if (date < this.today) {
              return cssClass;
            }
            if(date > this.maxDate){
              return cssClass;
            }
            var startdate = this.domHost.domHost.domHost.querySelector("#start").value;
            var endDate = this.domHost.domHost.domHost.querySelector("#end").value;
            if (startdate === undefined) {
              startDateDefined = false;
            }
            if (dateDiff(date, this.today) === 0 && startdate === undefined) {
              cssClass += ' selectToday';
              this.async(function () {
                this._updateSelection();
              });
            }
            else if (dateDiff(date, this.today) === 0 && dateDiff(startdate, this.today) != 0) {
              cssClass += ' selectToday';
              this.async(function () {
                this._updateSelection();
              });
            }

            var enddate;
            var startNotSelected = false;

            if (startdate === undefined) {
              startNotSelected = true;
              startdate = this.today;
            }
            startdate.setHours(0, 0, 0, 0);

            if (endDate === undefined) {
              enddate = startdate;
            }
            else {
              enddate = endDate;
              enddate.setHours(0, 0, 0, 0);
            }
            date.setHours(0, 0, 0, 0);
            if (date.getTime() === startdate.getTime() && this.today.getTime() != startdate.getTime()) {
              cssClass += ' selected';
              this.async(function () {
                this._updateSelection();
              });
            }
            if (date > startdate && date > enddate && this.domHost.domHost.LastStartDate === startdate) {
              return cssClass;
            }
            var checkDayName = this._checkDayName(date);
            var checkFirstDayWeek = this._checkFirstDayofWeek(date);
            var checkFirstDayOfMonth = this._checkFirstDayofMonth(date);
            var checkLastDayOfMonth = this._checkLastDayofMonth(date);
            var checkLastDayOfWeek = this._checkLastDayofWeek(date);

            if (date > startdate && date < enddate) {
              if (checkDayName != checkFirstDayWeek && date.getTime() != checkFirstDayOfMonth.getTime()) {
                cssClass += ' selectedRange';
                this.async(function () {
                  this._updateSelection();
                });
              }
            }
            if (date.getTime() === startdate.getTime() && startNotSelected == false) {
              cssClass += ' selectfirst';
              if (checkDayName != checkLastDayOfWeek && date.getTime() != checkLastDayOfMonth.getTime()) {
                cssClass += ' selectStartBorder';
              }
              this.async(function () {
                this._updateSelection();
              });
            }
            if (enddate != startdate) {
              if (date.getTime() === enddate.getTime()) {
                cssClass += ' selectlast';
                if (date.getTime() != checkFirstDayOfMonth.getTime() && checkDayName != checkFirstDayWeek) {
                  cssClass += ' selectEndBorder';
                }
                this.async(function () {
                  this._updateSelection();
                });
              }
            }

            if (date >= startdate && date < enddate) {

              if ((checkDayName === checkFirstDayWeek || date.getTime() === checkFirstDayOfMonth.getTime())) {
                cssClass += ' selectedRangeSun';
              }
              else if ((checkDayName === checkLastDayOfWeek || date.getTime() === checkLastDayOfMonth.getTime())) {
                cssClass += ' selectedRangeSat';
              }
              if ((checkDayName === checkLastDayOfWeek && date.getTime() === checkFirstDayOfMonth.getTime())) {
                cssClass += ' selectedRangeSat';
              }
              if ((checkDayName === checkFirstDayWeek && date.getTime() === checkLastDayOfMonth.getTime())) {
                cssClass += ' selectedRangeSat';
              }
            }

            //add 6 days

            var datepick = this.domHost.domHost.domHost.querySelector("#start").value;
            var datepickend = this.domHost.domHost.domHost.querySelector("#end").value;
            if (enddate === startdate || datepickend === undefined) {
              if (datepick === undefined) {

              }
              else {
                var newdate = new Date(datepick);
                newdate.setDate(newdate.getDate() + this.domHost.domHost.domHost.option.date.defaultStayDuration);
                var maxDt = this.maxDate;
                maxDt.setHours(0, 0, 0, 0);
                if (newdate > maxDt) {
                  newdate = maxDt;
                }
                var nd = new Date(newdate);
                datepick.setHours(0, 0, 0, 0);
                nd.setHours(0, 0, 0, 0);
                if (date.getTime() === nd.getTime()) {
                  cssClass += ' selectlast';
                  this.async(function () {
                    this._updateSelection();
                  });
                }

                if (date > datepick && date < nd) {
                  if (checkDayName != checkFirstDayWeek && date.getTime() != checkFirstDayOfMonth.getTime()) {
                    cssClass += ' selectedRange';
                    this.async(function () {
                      this._updateSelection();
                    });
                  }
                }
                if (date.getTime() === datepick.getTime()) {
                  cssClass += ' selectfirst';
                  this.async(function () {
                    this._updateSelection();
                  });
                }
                var endDate = this.domHost.domHost.domHost.querySelector("#end");
                endDate.value = nd;
              }
            }
            var maxDt = this.maxDate;
            maxDt.setHours(0, 0, 0, 0);
            cssClass = this._removeDuplicateWord(cssClass);
            if (date.getTime() === startdate.getTime()) {
              if (checkDayName === checkLastDayOfWeek) {
                cssClass = cssClass.replace("selectedRange", "");
                cssClass = cssClass.replace("selectedRangeSat", "");
              }
              else if (date.getTime() === checkLastDayOfMonth.getTime()) {
                cssClass = cssClass.replace("selectedRange", "");
                cssClass = cssClass.replace("selectedRangeSat", "");
              }
            }
            if (date.getTime() === startdate.getTime() && date.getTime() === maxDt.getTime()) {
              cssClass = cssClass.replace("selectlast", "");
              cssClass = cssClass.replace("selectedRange", "");
            }
            if (date.getTime() === this.today.getTime() && !startDateDefined) {
              cssClass = cssClass.replace("selectedRange", "");
            }
            if (date.getTime() === startdate.getTime() && checkDayName === checkFirstDayWeek) {
              cssClass = cssClass.replace("selectedRangeSun", "");
            }
            if (date.getTime() === startdate.getTime() && date.getTime() === checkFirstDayOfMonth.getTime()) {
              cssClass = cssClass.replace("selectedRangeSun", "");
            }
            if (date.getTime() === startdate.getTime() && date.getTime() === enddate.getTime()) {
              cssClass = cssClass.replace("selectStartBorder", "");
              cssClass = cssClass.replace("selectEndBorder", "");
            }
          }
          return cssClass;
        },

        _removeDuplicateWord: function (string) {
          var uniqueList = string.split(' ').filter(function (item, i, allItems) {
            return i == allItems.indexOf(item);
          }).join(' ');


          return uniqueList;
        },
        _checkDayName: function (date) {
          var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
          var d = new Date(date);
          var dayName = days[d.getDay()];
          return dayName;
        },
        _checkLastDayofMonth: function (date) {
          var d = new Date(date.getFullYear(), date.getMonth() + 1, 0);
          return d;
        },
        _checkFirstDayofMonth: function (date) {
          var d = new Date(date);
          d.setMonth(d.getMonth(), 1);
          d.setHours(0, 0, 0, 0);
          return d;
        },
        _checkFirstDayofWeek: function (date) {
          var dayName = this.querySelector("#weekday").textContent;
          if (dayName === "M") {
            return "Monday";
          }
          else {
            return "Sunday";
          }
        },
        _checkLastDayofWeek: function (date) {
          var dayName = this.querySelector("#weekday").textContent;
          if (dayName === "M") {
            return "Sunday";
          }
          else {
            return "Saturday";
          }
        },
        _isDisabled: function (day, date) {
          return !day || !this._withinValidRange(date);
        },
        _getMonthClass: function (name, month) {
          return name + ' month-' + month.year + '-' + month.month;
        },
        _onTrack: function (event) {
          var dx = event.detail.dx;
          var dy = event.detail.dy;
          var adx = Math.abs(dx);
          var ady = Math.abs(dy);
          var width = this._containerWidth;

          switch (event.detail.state) {
            case 'start':
              this._trackStartTime = (new Date()).getTime();
              this._startPos = this._currentPos;
              this._moveQueue = [];
              break;

            case 'track':
              if (this._moveQueue.length >= 4) {
                this._moveQueue.shift();
              }
              this._moveQueue.push(event);

              // ignore movement within WIGGLE_THRESHOLD
              var distance = (dx * dx) + (dy * dy);
              if (!this._gesture && distance > WIGGLE_THRESHOLD_SQUARE) {
                this._gesture = adx > ady ? 'pan-x' : 'pan-y';
              }

              // only drag during pan-x gesture
              if (this._gesture !== 'pan-x') {
                return;
              }

              this._dragging = true;
              var fullWidth = width * (this._months.length - 1);
              var x = this._startPos + dx;

              // If we're dragging outside the bounds, add some resistence
              if (x > 0 || x <= (-fullWidth + width)) {
                if (isNaN(parseInt(this._resistStart, 10))) {
                  this._resistStart = adx;
                }
                var rdx = adx - this._resistStart;
                var p, d, max = RESIST_LENGTH;
                p = rdx > width ? 1 : rdx / width;
                d = max * (1 - Math.pow(1 - p, RESIST_FACTOR));
                x = 0;
              } else {
                this._resistStart = null;
              }
              this._translateX(x);
              break;

            case 'end':
              this._resistStart = null;
              var lastIdx = this._getMonthIdx(this._startPos);
              var idx = this._getMonthIdx(this._currentPos);
              var lastIdx = this._getMonthIdx(this._startPos);
              var idx = this._getMonthIdx(this._currentPos);
              var speed = this._getFastestMovement(event).v;
              var move = idx !== lastIdx || speed > FLICK_SPEED;
      
              if (mq) {
                if (!this._resistStart && this._gesture === 'pan-y') {
                  if (speed > FLICK_SPEED) {
                    // calculate an ideal transition duration based on current speed of swipe
                    var remainingDistance = width - adx;
                    var newDuration = remainingDistance / speed;
                    if (newDuration > 300) {
                      newDuration = 300;
                    }
                    this._transitionDuration = newDuration;
                  }

                } else {
                  this._translateX(this._startPos, 'reset');
                }
                this._gesture = null;
              }
          }
        },

        _swipePrevMonth: function () {
          var startDate = this.domHost.domHost.domHost.querySelector("#start");
          var endDate = this.domHost.domHost.domHost.querySelector("#end");
          var scrollPrevMonth = this.domHost.domHost.id;
          if (scrollPrevMonth === "start" && this.today.getMonth() + 1 === this.currentMonth && this.today.getFullYear() === this.currentYear) {
            this._populate(this.today.getFullYear(), this.today.getMonth() + 1);
          }
          else if (scrollPrevMonth === "end" && startDate.value.getMonth() + 1 === this.currentMonth && startDate.value.getFullYear() === this.currentYear) {
            this._populate(startDate.value.getFullYear(), startDate.value.getMonth() + 1);
          }
          else {
            this.fire('swiped', { direction: 'right' });
          }
        },
        _swipeNextMonth: function () {
          if (!this.maxDate || this.currentYear < this.maxDate.getFullYear() || this.currentMonth < this.maxDate.getMonth() + 1) {
            this.fire('swiped', { direction: 'left' });
          }
        },
        _getMonthIdx: function (pos) {
          // returns the index for the visible month according to the given position
          var width = this._containerWidth;
          var i = Math.floor((-pos + (width / 2)) / width);
          return i < 0 ? 0 : i;
        },
        _translateX: function (x, transition, cb) {
          if (isNaN(parseInt(x, 10))) {
            // throw new Error('Not a number: ' + x);
          }
          this._currentPos = x;
          if (transition) {
            if (this._transitionDuration) {
              this.$.months.style.transitionDuration = this._transitionDuration + 'ms';
            }
            this._once(this._transitionEvent, function () {
              this.set('_contentClass', '');
              this.$.months.style.transitionDuration = '';
              this._transitionDuration = null;
              this.$.monthNav.style.removeProperty('opacity');
              if (cb) {
                cb();
              }
            }.bind(this), this.$.months);
            this.set('_contentClass', 'animating ' + transition);
            this.$.monthNav.style.removeProperty('opacity');
            // Fixes odd bug in chrome where we lose touch-events after changing opacity
            this._once('touchstart', function () { });
          }
          window.requestAnimationFrame(function () {
            if (!transition) {
              var halfWidth = this._containerWidth / 2;
              var dx = Math.abs(this._startPos - x);
              var p = (1 - (dx / halfWidth)) * 100;
              p = (100 - Math.pow(p, 2)) / 100 / 100;
              var opacity = Math.abs(parseFloat(p).toFixed(2));
              this.$.monthNav.style.opacity = opacity;
            }
            this.transform('translateX(' + x + 'px)', this.$.months);
          }.bind(this));
        },
       
        _getFastestMovement: function (event) {
          // detect flick based on fastest segment of movement
          var l = this._moveQueue.length;
          var dt, tx, ty, tv2, x = 0, y = 0, v2 = 0;
          for (var i = 0, m; i < l && (m = this._moveQueue[i]); i++) {
            dt = event.timeStamp - m.timeStamp;
            tx = (event.detail.x - m.detail.x) / dt;
            ty = (event.detail.y - m.detail.y) / dt;
            tv2 = tx * tx + ty * ty;
            if (tv2 > v2) {
              x = tx;
              y = ty;
              v2 = tv2;
            }
          }
          return { x: x, y: y, v: Math.sqrt(v2) };
        },
        _onSwipe: function (event) {
          if (event.detail.direction === 'right') {
            this._prevMonth();
          }
          else {
            this._nextMonth();
          }
        },
        _once: function (eventName, callback, node) {
          node = node || this;
          function onceCallback() {
            node.removeEventListener(eventName, onceCallback);
            callback.apply(null, arguments);
          }
          node.addEventListener(eventName, onceCallback);
        },
        _incrMonth: function (i) {
          var date = new Date(this.currentYear, this.currentMonth - 1 + i);
          var year = date.getFullYear();
          var month = date.getMonth() + 1;
          if (this._monthWithinValidRange(year, month)) {
            this.currentYear = year;
            this.currentMonth = month;
          }
        },
        _prevMonth: function () {
          this._incrMonth(-1);
        },
        _nextMonth: function () {
          this._incrMonth(1);
        },

        _tapDay: function (event) {
          var startDate = this.domHost.domHost.domHost.querySelector("#start");
          var endDate = this.domHost.domHost.domHost.querySelector("#end");
          var modelItemDate = event.model.item.date;
          var newDate;
          if (!this._withinValidRange(modelItemDate)) {
            event.preventDefault();
            event.stopPropagation();
            return;
          }
          var item = event.model.item;
          item.year = modelItemDate.getFullYear();
          if (item.date.getTime() == this._checkLastDayofMonth(item.date).getTime()) {
            newDate = new Date(item.date.getTime());
          }
          else {
            newDate = new Date(this.date.getTime());
          }
          newDate.setDate(item.day);
          newDate.setYear(item.year);
          newDate.setMonth(item.month);
          this.date = newDate;
          if (this.domHost.domHost.id === "start") {
            startDate.value = newDate;
             if(mq){ 
              endDate.minDate = startDate.value;
              //  var setMax =startDate.value;
              // var setMaxDate = new Date();
              // setMaxDate.setDate(setMax.getDate() + this.domHost.domHost.domHost.option.date.maxStayDuration);
              // endDate.maxDate = setMaxDate; 
              endDate._showDialog();            
          }
          else{
             endDate.minDate = startDate.value;
              // var setMax =startDate.value;
              // var setMaxDate = new Date();
              // setMaxDate.setDate(setMax.getDate() + this.domHost.domHost.domHost.option.date.maxStayDuration);
              // endDate.maxDate = setMaxDate; 
              endDate._showDialog(); 
          }
            if (startDate.value > endDate.value) {
              endDate.value = newDate;
            }
          }
          else if (this.domHost.domHost.id === "end") {
            if (item.date.getTime() === startDate.value.getTime()) {
              event.preventDefault();
              event.stopPropagation();
              return;
            }
            endDate.value = newDate;
            if (mq) {
              event.stopPropagation();
            }
            if (startDate.value.getMonth() === endDate.value.getMonth()) {
              this._populate(endDate.value.getFullYear(), endDate.value.getMonth() + 1);
            }
            else {
              this._populate(startDate.value.getFullYear(), startDate.value.getMonth() + 1);
            }
          }

          var isIE = /*@cc_on!@*/false || !!document.documentMode;
          if (isIE) {
            this.domHost.domHost.querySelector("#input").querySelector("#input").focus();
            this.domHost.domHost.querySelector("#input").querySelector("#input").blur();
          }
        },


        _isValidDate: function (date) {
          return date && date.getTime && !isNaN(date.getTime());
        },
        _withinValidRange: function (date) {
          if (this._isValidDate(date)) {
            return (!this.minDate || date >= this.minDate) && (!this.maxDate || date <= this.maxDate);
          }
          return false;
        },
        _monthWithinValidRange: function (year, month) {
          var monthStart = new Date(year, month - 1, 1);
          var monthEnd = new Date(year, month, 0);
          return this._withinValidRange(monthStart) || this._withinValidRange(monthEnd);
        },
        _positionSlider: function () {
          if (!this._months || !this._containerWidth) {
            return;
          }

            var i = ((this.currentYear * 12) + this.currentMonth) -
              ((this._months[0].year * 12) + this._months[0].month);
            this._translateX(0 * this._containerWidth);
  
        },
        _updateSelection: function () {
          // Force the day selection circle to maintain a 1:1 ratio
           this.async(function () {
          var selected = this.$$('.selected');
          if (!selected) {
            return;
          }
          selected.style.height = '';
          selected.style.width = '';
          var w = selected.parentElement.offsetWidth;
          var h = selected.parentElement.offsetHeight;
          selected.style.flex = '';
          window.requestAnimationFrame(function () {
            if (w > 0 && w < h) {
              selected.style.height = h + 'px';
            }
            else if (h > 0) {
              selected.style.width = w + 'px';
            }
          });
           });
        },
        _resizeHandler: function () {
            this.async(function () {
          this._containerWidth = this.$.calendar.offsetWidth;
          // this._positionSlider();
          this._updateSelection();
            });
        },
        _getDayName: function (date) {
          return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
        },
        _updateToday: function () {
          this.today = new Date();
          this.today.setHours(0, 0, 0, 0);
        },
        _whichTransitionEnd: function () {
          var transitions = {
            'WebkitTransition': 'webkitTransitionEnd',
            'MozTransition': 'transitionend',
            'OTransition': 'oTransitionEnd otransitionend',
            'transition': 'transitionend'
          };

          for (var t in transitions) {
            if (this.style[t] !== undefined) {
              return transitions[t];
            }
          }
        }
      });
    })();
  </script>
</dom-module>